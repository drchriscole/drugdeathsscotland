---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(readxl)
library(reshape2)
library(ggplot2)
library(tibble)
library(dplyr)

# default region colours
reg.colours = c("#4D4D4D", "#AEAEAE")

# The colour-blind palette with grey:
myPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000")

# read data - download first as read_excel() can't do URLs
xlfile = tempfile(fileext = '.xlsx')
download.file("https://www.nrscotland.gov.uk/files//statistics/drug-related-deaths/2018/drug-related-deaths-18-tabs-figs.xlsx", xlfile, mode="wb")

```

# Drug-Related Deaths in Scotland 2018 {.tabset}

Annual data is published on drug-related deaths (DRDs) in Scotland by the [National Records of Scotland](https://www.nrscotland.gov.uk/statistics-and-data/statistics/statistics-by-theme/vital-events/deaths/drug-related-deaths-in-scotland).

A collection of visualisations of the [2018 data](https://www.nrscotland.gov.uk/files//statistics/drug-related-deaths/17/drug-related-deaths-18-tabs-figs.xlsx) are presented here for those interested in exploring the trends or patterns in the data. Little to no commentary is provided on what the data show.

Each table from the data are presented separately by one or more charts. Not all tables are presented either because the data is incomplete or has already been presented in the raw data already.

All analyses and code are available on [github](https://github.com/drchriscole/drugdeathsscotland) for others to use. Comments and suggestion welcome.

## Table 2

```{r t2}
# read data
table8.dat = read_excel(xlfile, sheet = 4, col_names=FALSE)

# extract core data and convert to numbers
dat = table8.dat[38:45,c(1,3:7)]
dat = data.frame(apply(dat, 2, as.numeric))

# add colnames
colnames(dat) <- c('Year','Drug Abuse','Accidental Poisoning','Suicide','Assault by Drugs','Undetermined')

# factorise the years to turn into a label and melt
dat$Year <- factor(dat$Year)
dat.m = melt(dat)

year.totals = dat.m %>% group_by(Year) %>% summarise(Total = sum(value))

ggplot(dat.m, aes(x=Year, y=value, fill=variable)) + 
  ggtitle("Underlying Cause of Death") +
  ylab("No. Deaths") +
  geom_col() +
  geom_text(aes(x=Year, y=Total+28, label = Total, fill = NULL), data=year.totals, size=2.8) +
  scale_fill_manual(values = myPalette) +
  theme_minimal() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.title = element_blank())

```

## Table 3

```{r t3, fig.width=7}
# read data
table.dat = read_excel(xlfile, sheet = 5, col_names=FALSE)

# extract core data and convert to numbers
dat = table.dat[18:36,c(1,3:18)]
dat = data.frame(apply(dat, 2, as.numeric))

colnames(dat) <- c('Year','Heroin.morphine','Methadone','HeroinOST','Codeine', 'Dihydrocodeine', 'Any opiate', 'Anybenzo', 'Presbenzo', 'Diazepam', 'Streetbenzo', 'Etizolam', 'GabaPre', 'Cocaine', 'Ecstasy', 'Amphetamines', 'Alcohol')

# combine the codeine/dihydrocodeine cols and remove
dat = data.frame(dat, Codeines = dat$Codeine + dat$Dihydrocodeine)

# subtract the diazepam data from 
# the any prescsribed benzo data to make an "other pres benzo" column
dat = data.frame(dat, "Otherpbenzo"=dat$Presbenzo - dat$Diazepam)

# similarly subtract etz for street benzo to 
# give other street benzo
dat = data.frame(dat, "Othersbenzo"=dat$Streetbenzo - dat$Etizolam)

# remove uninterest columns:
#   heroin or OST and any opiate are not very informative
#   Codeine/dihydrocodeine unnecessary now as they've been combined
#   any benzo is superceded by other benzos
# individual cases)
dat = dat[,c(1:3,8:20)]

opiates = dat[,names(dat) %in% c('Year','Heroin.morphine','Methadone','Diazepam','Etizolam', 'Codeines','Otherpbenzo','Othersbenzo')]
others = dat[,names(dat) %in% c('Year','GabaPre','Cocaine','Ecstasy','Amphetamines','Alcohol')]

# factorise the years to turn into a label and melt
opiates$Year <- factor(opiates$Year)
opiates.m = melt(opiates)

ggplot(opiates.m, aes(x=Year, y=value, group=variable, colour=variable)) +
  ggtitle("Drugs Implicated in Death", subtitle = 'Opiates and benzodiazepines') +
  ylab("No. of Deaths") +
  ylim(c(0,600)) +
  geom_vline(xintercept=which(opiates$Year == '2008'), colour="grey", linetype="dashed") +
  geom_line(size=1.1) +
  scale_color_manual(values = myPalette, labels = c('Heroine or Morphine','Methadone','Diazepam','Etizolam','Codeines','Other prescribed \nbenzodiazepines','Other street\nbenzodiazipnes')) +
  scale_x_discrete(breaks = seq(2000,2018,2)) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.title = element_blank())


# factorise the years to turn into a label and melt
others$Year <- factor(others$Year)
others.m = melt(others)

ggplot(others.m, aes(x=Year, y=value, group=variable, colour=variable)) +
  ggtitle("Drugs Implicated in Death", subtitle = 'Others') +
  ylab("No. of Deaths") +
  ylim(c(0,600)) +
  geom_vline(xintercept=which(opiates$Year == '2008'), colour="grey", linetype="dashed") +
  geom_line(size=1.1) +
  scale_color_manual(values = myPalette, labels = c('Gabapentin or\nPregabalin','Cocaine','Ecstasy','Amphetamines','Alcohol')) +
  scale_x_discrete(breaks = seq(2000,2018,2)) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.title = element_blank())


```

NB: data prior to 2008 uses a different definition than the data from 2008. See notes in table 3.


## Table 4

Table 4 describes quite a lot of data represented in different ways. Each is presented as a different plot.

```{r t4a}
# read data
table.dat = read_excel(xlfile, sheet = 6, col_names=FALSE)

# extract core data and convert to numbers  there are some 
# columns used as fillers. Gah!
dat = table.dat[16:34,c(1,2,4,5,7:13,15:17)]
dat = data.frame(apply(dat, 2, as.numeric))

colnames(dat) <- c('Year','all','male','female','u14','15_24','25_34','35_44','45_54','55_64','o65','lq','median','uq')

ggplot(dat, aes(x=Year, y=median)) + 
  ggtitle("Median Age at Death", subtitle = 'Shaded area represents the lower to upper quartile range of ages.') +
  ylab("Age") +
  geom_line(size=1.2) +
  ylim(c(0,50)) +
  stat_summary(ymin=dat$lq, ymax=dat$uq, geom="ribbon", alpha=0.2, fill='red') +
  scale_x_continuous(breaks = seq(2000,2018,2)) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.title = element_blank())
```



Median age of drug-related death is increasing from 30 in 2000 to 41 in 2017.

```{r t4b}
# calc percentage m/f deaths
dat = data.frame(dat, fempc = 100*dat$female/dat$all, malpc = 100*dat$male/dat$all)

dat$Year = factor(dat$Year)
dat.sex = dat[,c('Year','fempc','malpc')]
dat.sex.m = melt(dat.sex)

ggplot(dat.sex.m, aes(x=Year, y=value, group=variable, colour=variable)) + 
  ggtitle("Percentage of Male vs Female Deaths") +
  ylab("Percentage Deaths") +
  geom_line(size=1.2) +
  ylim(c(10,90)) +
  scale_color_discrete(name='Sex', breaks=c('malpc','fempc'),labels=c('Male','Female')) +
  scale_x_discrete(breaks = seq(2000,2018,2)) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.title = element_blank())
```

Males are mostly affected by drug-related deaths, but females are increasing.

```{r t4c}
## get data from lower table

calc_percent <- function(x) {
  year = x[1]
  x = x[-1]
  total = sum(x)
  pc.x = round(100*x/total,2)
  return(c(year, pc.x))
}

# read data
table.dat = read_excel(xlfile, sheet = 6, col_names=FALSE)

# extract male data and convert to numbers  there are some 
# columns used as fillers. Gah!
mdat = table.dat[45:63,c(1,4,5,7:9)]
mdat = data.frame(apply(mdat, 2, as.numeric))

# turn into percentages
mdat = data.frame(t(apply(mdat,1,calc_percent)))
colnames(mdat) <- c('Year','u24','25-34','35-44','45-54','o55')

# extract female data and convert to numbers  there are some 
# columns used as fillers. Gah!
fdat = table.dat[45:63,c(1,12:13,15:17)]
fdat = data.frame(apply(fdat, 2, as.numeric))

# turn into percentages
fdat = data.frame(t(apply(fdat,1,calc_percent)))
colnames(fdat) <- c('Year','u24','25-34','35-44','45-54','o55')

dat = rbind(mdat,fdat)

dat = data.frame(dat, Sex=rep(c('Male','Female'),each=nrow(mdat)))

dat$Year = factor(dat$Year)
dat.m = melt(dat)

ggplot(dat.m, aes(x=Year, y=value, fill=variable)) +
  ggtitle('Deaths by Sex and Age') +
  ylab('Percentage Deaths') +
  geom_col() +
  facet_grid(Sex ~ .) +
  scale_fill_manual(name='Age', labels=c('under 25','25-34','35-44','45-54', 'over 55'), values = myPalette) +
  scale_x_discrete(breaks = seq(2000,2018,2)) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        strip.background = element_rect(fill='grey'),
        legend.title = element_blank())


```

In 2000 deaths were largely in the under 35s. In 2018 they are dominated by the 35 and over. Particluarly in females.

## Table 5

```{r t5, fig.width=5, fig.height=6.5}
# read data
table.dat = read_excel(xlfile, sheet = 7, col_names=FALSE)

# extract core data and convert to numbers
dat = table.dat[c(22:26,29:33),c(1,3:5,7)]
#dat = data.frame(apply(dat, 2, as.numeric))
colnames(dat) <- c("Age",'Drug Abuse','Accident','Suicide','Undetermined')
dat = data.frame(dat, Sex = rep(c("Male","Female"), each = 5))
dat.m = melt(dat, id=c('Age','Sex'))
dat.m$value = as.numeric(dat.m$value)
dat.m$Age = factor(dat.m$Age, levels = c('Under 25','25-34','35-44','45-54','55 and over'))

age.totals = dat.m %>% group_by(Age,Sex) %>% summarise(Total = sum(value))


ggplot(dat.m, aes(x=Age, y=value, fill=variable)) + 
  ggtitle("Drug-Related Deaths in Scotland", subtitle="By Sex, Age and Underlying Cause of Death") +
  ylab('No. Deaths') +
  geom_col() +
  facet_grid(Sex ~ .) +
  scale_fill_manual(values = myPalette) +
  geom_text(aes(x=Age, y=Total+14, label = Total, fill = NULL), data=age.totals, size=2.8) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        strip.background = element_rect(fill='grey'),
        legend.title = element_blank())



```

## Table 6

```{r t6, fig.width=6, fig.height=5}

# read data
table.dat = read_excel(xlfile, sheet = 8, col_names=FALSE)

# extract core data and convert to numbers
dat = table.dat[c(26:30,33:37),c(1,3:18)]
colnames(dat) <-c('Age','Heroin.morphine','Methadone','HeroinOST','Codeine', 'Dihydrocodeine', 'Any opiate', 'Anybenzo', 'Presbenzo', 'Diazepam', 'Streetbenzo', 'Etizolam', 'GabaPre', 'Cocaine', 'Ecstasy', 'Amphetamines', 'Alcohol')

# combine the codeine/dihydrocodeine cols and remove
dat = data.frame(dat, Codeines = as.numeric(dat$Codeine) + as.numeric(dat$Dihydrocodeine))

# subtract the diazepam data from 
# the any prescsribed benzo data to make an "other pres benzo" column
dat = data.frame(dat, "Otherpbenzo"=as.numeric(dat$Presbenzo) - as.numeric(dat$Diazepam))

# similarly subtract etz for street benzo to 
# give other street benzo
dat = data.frame(dat, "Othersbenzo"=as.numeric(dat$Streetbenzo) - as.numeric(dat$Etizolam))

# remove uninterest columns:
#   heroin or OST and any opiate are not very informative
#   Codeine/dihydrocodeine unnecessary now as they've been combined
#   any benzo is superceded by other benzos
# individual cases)
dat = dat[,c(1:3,10,12:20)]

dat = data.frame(dat, Sex = rep(c("Male","Female"), each = 5))
dat.m = melt(dat, id=c('Age','Sex'))
dat.m$value = as.numeric(dat.m$value)
dat.m$Age = factor(dat.m$Age, levels = c('Under 25','25-34','35-44','45-54','55 and over'))

ggplot(dat.m, aes(x=variable, y=value, fill=Age)) + 
  ggtitle("Drug-Related Deaths in Scotland", subtitle="By Sex, Age and Implicated Drug") +
  ylab('No. Deaths') +
  xlab('') +
  geom_col() +
  facet_grid(Sex ~ .) +
  coord_flip() +
  scale_fill_manual(values = myPalette) +
#  c('Other street benzo', 'Other prescribed benzo', 'Codeines', 'Alcohol', 'Amphetamines', 'Ecstasy', 'Cocaine', 'Gapapentin or\nPregabalin', 'Etizolam', 'Diazepam', 'Methadone', 'Heroine or morphine')
  scale_x_discrete(labels = c( 'Heroine or morphine', 'Methadone', 'Diazepam', 'Etizolam', 'Gapapentin or\nPregabalin', 'Cocaine', 'Ecstasy', 'Amphetamines', 'Alcohol', 'Codeines', 'Other prescribed benzo', 'Other street benzo')) +
#  geom_text(aes(x=Age, y=Total+14, label = Total, fill = NULL), data=age.totals, size=2.8) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        strip.background = element_rect(fill='grey'),
        legend.title = element_blank())


```

NB: Totals in this chart will be higher than total number of deaths as deaths can have more than one drug implicated.

## Table 8

```{r t8}
# read data
table8.dat = read_excel(xlfile, sheet = 10, col_names=FALSE)

# extract core data and convert to numbers
dat = table8.dat[11:28,2:6]
dat = data.frame(apply(dat, 2, as.numeric))

# extract mean for last five years
yr5mean = as.numeric(table8.dat[31,7])

# add labels
names(dat) <- c("15-24","25-34","35-44","45-54","55-64")
dat = cbind(Year=factor(seq(2000,2017)), dat)

# melt data and plot
# note: dashed line is for average deaths 2012-2016 for ages 15-64
dat.m = melt(dat, variable.name = "Age")
ggplot(dat.m, aes(x=Year, y=value, group=Age, colour=Age)) + 
  geom_hline(yintercept = yr5mean, colour="grey", linetype="dashed") + 
  geom_line(size=1.2) + 
  ylab("Deaths per 1000 population") + 
  annotate("text", label="Mean 2014-2018", x=16.8,y=yr5mean-0.015,size=3,colour="grey") +
  scale_x_discrete(breaks=seq(2000,2018,2)) + 
  scale_color_manual(values=myPalette) +
  ggtitle("Death Rates by Age") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())



```

## Table HB2

```{r tHB2a}
# read data
table.dat = read_excel(xlfile, sheet = "HB1 - summary", col_names=FALSE)

# extract core data and convert to numbers
dat = table.dat[14:27,1:12]
colnames(dat) = c('Region', seq(2008,2018,1))
dat[dat$Region == 'Highland 3' , 1] = 'Highland'
dat[dat$Region == 'Greater Glasgow & Clyde 3' , 1] = 'Greater Glasgow & Clyde'

dat$Region = factor(dat$Region, c(dat[order(dat$`2018`),]$Region))

dat.m = melt(dat)

ggplot(dat, aes(x=Region, y=`2008`)) +
  ggtitle("Drug-Related Deaths in Scotland", subtitle="Change between 2008 - 2018") +
  geom_linerange(aes(ymin=`2008`,ymax=`2018`), colour='grey', size=1.5) +
  geom_point(aes(y=`2008`), size =1.2, colour='orange') +
  geom_point(aes(y=`2018`), size =1.2, colour='orange') +
  geom_point(aes(y=`2017`), size =1.2, colour='darkgreen') +
  geom_text(aes(y=`2017`, label = ifelse(Region == "Greater Glasgow & Clyde", '2017', '')), vjust = -0.5, size=2.8, colour="grey30") +
  geom_text(aes(y=`2008`, label = ifelse(Region == "Greater Glasgow & Clyde", '2008', '')), vjust = -0.5, size=2.8, colour="grey30") +
  geom_text(aes(y=`2018`, label = ifelse(Region == "Greater Glasgow & Clyde", '2018', '')), vjust = -0.5, size=2.8, colour="grey30") +
  ylab('No. Deaths') +
  xlab('') +
  coord_flip() +
  theme_minimal()
```

```{r tHBb}

# remove islands as numbers to small
dat = dat[dat$`2017` > 5,]

# do percentage change between 2017 & 2018
change.dat = data.frame(Region = dat$Region, Change = round(100*(dat$`2018` - dat$`2017`)/dat$`2017`,1))

change.dat$Region = factor(change.dat$Region, levels = change.dat[order(change.dat$Change),]$Region)

ggplot(change.dat, aes(x=Region, y=Change, fill="#D55E00")) +
  ggtitle("2018 Change in Drug-Related Deaths", subtitle="By health board (%)") +
  ylab("% Change") +
  xlab('') +
  geom_col() +
  ylim(c(-15,110)) +
  coord_flip() +
  geom_text(aes(label = sprintf("%.1f%%",Change)), hjust = ifelse(change.dat$Change > 0, -0.2, 1.1), size=3) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        legend.position = "none")
  


```

